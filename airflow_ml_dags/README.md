# Machine Learning in Production Course: Homework 3
Maintainer: [Ruslan Akhmerov](https://data.mail.ru/profile/r.akhmerov/)

Status: 99.9% ready for PR ðŸ˜…

## Configure
Airflow parameters can be found and changed in `dags/constants.py`

## Run Airflow
From directory with `docker-compose.yml`:
```bash
# Unix host
export GMAIL_USR=your_login@gmail.com
export GMAIL_PWD=your_gmail_password
export FERNET_KEY=$(python -c "from cryptography.fernet import Fernet; FERNET_KEY = Fernet.generate_key().decode(); print(FERNET_KEY)")

# Windows host
set GMAIL_USR=your_login@gmail.com
set GMAIL_PWD=your_gmail_password
python -c "import os; from cryptography.fernet import Fernet; FERNET_KEY = Fernet.generate_key().decode(); print(FERNET_KEY);" > tmp.txt
set /P FERNET_KEY=<tmp.txt
del tmp.txt

# Any host
docker-compose up --build
```

## Stop Airflow
```bash
docker-compose down
docker system prune  # yes
docker volume prune  # yes
docker network prune  # yes
```

## Test DAGs
Tests will probably crash on Windows host due to: https://stackoverflow.com/questions/52779920/why-is-signal-sigalrm-not-working-in-python-on-windows
```bash
pytest -v
```

## Project Roadmap
- [X] ÐŸÐ¾Ð´Ð½Ð¸Ð¼Ð¸Ñ‚Ðµ airflow Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ docker compose (Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð· Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð° https://github.com/made-ml-in-prod-2021/airflow-examples/)
- [X] (5 Ð±Ð°Ð»Ð»Ð¾Ð²) Ð ÐµÐ°Ð»Ð¸Ð·ÑƒÐ¹Ñ‚Ðµ dag, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¼Ð¾Ð´ÐµÐ»Ð¸ (Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ, Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ°Ðº Ð³ÐµÐ½ÐµÑ€Ð°Ñ‚Ð¾Ñ€ ÑÐ¸Ð½Ñ‚ÐµÑ‚Ð¸ÐºÐ¸ Ð¸Ð· Ð¿ÐµÑ€Ð²Ð¾Ð¹ Ð´Ð·, Ñ‚Ð°Ðº Ð¸ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð¸Ð· Ð´Ð°Ñ‚Ð°ÑÐµÑ‚Ð¾Ð² sklearn), Ð²Ð°Ð¼ Ð²Ð°Ð¶Ð½Ð¾ Ð¿Ñ€Ð¾ÑÐ¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ¸Ñ‚ÑƒÐ°Ñ†Ð¸Ð¸ Ð¿Ð¾ÑÑ‚Ð¾ÑÐ½Ð½Ð¾ Ð¿Ð¾ÑÑ‚ÑƒÐ¿Ð°ÑŽÑ‰Ð¸Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… - Ð·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°Ð¹Ñ‚Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² /data/raw/{{ ds }}/data.csv, /data/raw/{{ ds }}/target.csv
- [X] (10 Ð±Ð°Ð»Ð»Ð¾Ð²) Ð ÐµÐ°Ð»Ð¸Ð·ÑƒÐ¹Ñ‚Ðµ dag, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¾Ð±ÑƒÑ‡Ð°ÐµÑ‚ Ð¼Ð¾Ð´ÐµÐ»ÑŒ ÐµÐ¶ÐµÐ½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¾, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð° Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð´ÐµÐ½ÑŒ. Ð’ Ð²Ð°ÑˆÐµÐ¼ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ðµ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ ÐºÐ°Ðº Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 4 ÑÑ‚Ð°Ð´Ð¸Ð¸, Ð½Ð¾ Ð´Ð°Ð¹Ñ‚Ðµ Ð²Ð¾Ð»ÑŽ ÑÐ²Ð¾ÐµÐ¹ Ñ„Ð°Ð½Ñ‚Ð°Ð·Ð¸Ð¸=)
    - [X] Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ(Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð¸Ð· /data/raw/{{ ds }} Ð¸ Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ /data/processed/{{ ds }}/train_data.csv)
    - [X] Ñ€Ð°ÑÐ¿Ð»Ð¸Ñ‚Ð¸Ñ‚ÑŒ Ð¸Ñ… Ð½Ð° train/val
    - [X] Ð¾Ð±ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð½Ð° train (ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð² /data/models/{{ ds }} 
    - [X] Ð¿Ñ€Ð¾Ð²Ð°Ð»Ð¸Ð´Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð½Ð° val (ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ðº Ð¼Ð¾Ð´ÐµÐ»ÑŒÐºÐµ)
- [X] Ð ÐµÐ°Ð»Ð¸Ð·ÑƒÐ¹Ñ‚Ðµ dag, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ð¼Ð¾Ð´ÐµÐ»ÑŒ ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾ (5 Ð±Ð°Ð»Ð»Ð¾Ð²)
    - [X] Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚ Ð½Ð° Ð²Ñ…Ð¾Ð´ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ð¿ÑƒÐ½ÐºÑ‚Ð° 1 (data.csv)
    - [ ] ÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð¿ÑƒÑ‚ÑŒ Ð´Ð¾ Ð¼Ð¾Ð´ÐµÐ»ÑŒÐºÐ¸ Ð¸Ð· airflow variables(Ð¸Ð´ÐµÑ Ð² Ñ‚Ð¾Ð¼, Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð³Ð´Ð° Ð½Ð°Ð¼ Ð½Ñ€Ð°Ð²Ð¸Ñ‚ÑÑ Ð´Ñ€ÑƒÐ³Ð°Ñ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð¸ Ð¼Ñ‹ Ñ…Ð¾Ñ‚Ð¸Ð¼ ÐµÐµ Ð½Ð° Ð¿Ñ€Ð¾Ð´ 
    - [X] Ð´ÐµÐ»Ð°ÐµÑ‚ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ðµ Ð¸ Ð·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ Ð¸Ñ… Ð² /data/predictions/{{ds }}/predictions.csv
- [X] Ð ÐµÐ°Ð»Ð¸Ð·ÑƒÐ¹Ñ‚Ðµ ÑÐµÐ½ÑÐ¾Ñ€Ñ‹ Ð½Ð° Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹ Ð´Ð»Ñ Ð´Ð°Ð³Ð¾Ð² Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ¸ Ð¸ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ (3 Ð´Ð¾Ð¿ Ð±Ð°Ð»Ð»Ð°)
- [X] Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ 2 Ð¿ÑƒÑ‚Ð¸ Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð”Ð—. 
    - [ ] Ð¿Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹ Ð² Ð¾Ð±Ñ€Ð°Ð· Ñ airflow Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ bash operator, python operator (0 Ð±Ð°Ð»Ð»Ð¾Ð²)
    - [X] Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ DockerOperator, Ñ‚Ð¾Ð³Ð´Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ð¸Ð· Ñ‚Ð°ÑÐ¾Ðº Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒÑÑ Ð² ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ðµ
        - [X] 1 Ð¸Ð· Ð´Ð°Ð³Ð¾Ð² Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ DockerOperator (5 Ð±Ð°Ð»Ð»Ð¾Ð²)
        - [X] Ð²ÑÐµ Ð´Ð°Ð³Ð¸ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ DockerOperator (10 Ð±Ð°Ð»Ð»Ð¾Ð²) (Ð¿Ñ€Ð¸Ð¼ÐµÑ€ https://github.com/made-ml-in-prod-2021/airflow-examples/blob/main/dags/11_docker.py).
    ÐŸÐ¾ Ñ‚ÐµÑ…Ð½Ð¸ÐºÐµ, Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ñ‚Ð°ÐºÑƒÑŽ Ð¶Ðµ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ ÐºÐ°Ðº Ð² Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ðµ, Ð¿Ð°ÐºÑƒÑŽ Ð² Ñ€Ð°Ð·Ð½Ñ‹Ðµ Ð´Ð¾ÐºÐµÑ€Ñ‹ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹, Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ð±Ñ‰Ð¸Ð¹ Ð´Ð¾ÐºÐµÑ€ Ñ Ð²Ð°ÑˆÐ¸Ð¼ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð¼, Ð½Ð¾ Ñ Ñ€Ð°Ð·Ð½Ñ‹Ð¼Ð¸ Ñ‚Ð¾Ñ‡ÐºÐ°Ð¼Ð¸ Ð²Ñ…Ð¾Ð´Ð° Ð´Ð»Ñ Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ñ‚Ð°ÑÐ¾Ðº. 
    ÐŸÑ€Ð¸ÐºÐ¾Ð»ÑŒÐ½Ð¾, ÐµÑÐ»Ð¸ Ð²Ñ‹ Ð¿Ð¾ÐºÐ°Ð¶ÐµÑ‚Ðµ, Ñ‡Ñ‚Ð¾ Ð´Ð»Ñ Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ñ‚Ð°ÑÐ¾Ðº Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ñ€Ð°Ð·Ð½Ñ‹Ð¹ Ð½Ð°Ð±Ð¾Ñ€ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹.
    https://github.com/made-ml-in-prod-2021/airflow-examples/blob/main/dags/11_docker.py#L27 Ð² ÑÑ‚Ð¾Ð¼ Ð¼ÐµÑÑ‚Ðµ Ð¿Ñ€Ð¾Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¿ÑƒÑ‚ÑŒ Ñ Ñ…Ð¾ÑÑ‚Ð¾Ð²Ð¾Ð¹ Ð¼Ð°ÑˆÐ¸Ð½Ñ‹, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð·Ð´ÐµÑÑŒ Ð¿ÑƒÑ‚ÑŒ Ñ‚Ð¸Ð¿Ð° /tmp Ð¸Ð»Ð¸ ÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ð¹Ñ‚Ðµ Ð¸Ð· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ.
- [X] ÐŸÑ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð²Ð°ÑˆÐ¸ Ð´Ð°Ð³Ð¸ (5 Ð±Ð°Ð»Ð»Ð¾Ð²) https://airflow.apache.org/docs/apache-airflow/stable/best-practices.html
- [ ] Ð’ docker compose Ñ‚Ð°Ðº Ð¶Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ Ð¿Ð¾Ð´Ð½ÑÑ‚Ð¸Ðµ mlflow Ð¸ Ð·Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ñ‚ÑƒÐ´Ð° Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ, Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ð¸ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚(Ð¼Ð¾Ð´ÐµÐ»ÑŒ) (5 Ð´Ð¾Ð¿ Ð±Ð°Ð»Ð»Ð¾Ð²)
- [ ] Ð²Ð¼ÐµÑÑ‚Ð¾ Ð¿ÑƒÑ‚Ð¸ Ð² airflow variables  Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð°Ð¿Ð¸ Mlflow Model Registry (5 Ð´Ð¾Ð¿ Ð±Ð°Ð»Ð»Ð¾Ð²)
- [X] ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ alert Ð² ÑÐ»ÑƒÑ‡Ð°Ðµ Ð¿Ð°Ð´ÐµÐ½Ð¸Ñ Ð´Ð°Ð³Ð° (3 Ð´Ð¾Ð¿. Ð±Ð°Ð»Ð»Ð°) https://www.astronomer.io/guides/error-notifications-in-airflow
- [X] Ñ‚Ñ€Ð°Ð´Ð¸Ñ†Ð¸Ð¾Ð½Ð½Ð¾, ÑÐ°Ð¼Ð¾Ð¾Ñ†ÐµÐ½ÐºÐ° (1 Ð±Ð°Ð»Ð»)


## Ð¡Ð°Ð¼Ð¾Ð¾Ñ†ÐµÐ½ÐºÐ°
```
  0  Ð—Ð° Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ Ñ ÐµÑÑ‚ÑŒ
+ 5  DAG Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…
+ 10 DAG Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ð° Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¼Ð¾Ð´ÐµÐ»Ð¸
+ 5  DAG Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¸ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ð¹
+ 3' ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ð» ÑÐµÐ½ÑÐ¾Ñ€Ñ‹, Ð²ÑÑ‘ Ð¿Ð¾ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ
+ 10 Ð’ÑÑ‘ Ð½Ð° Ð´Ð¾ÐºÐµÑ€-Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°Ñ…
+ 5  ÐÐ°Ð¿Ð¸ÑÐ°Ð½Ñ‹ Ñ‚ÐµÑÑ‚Ñ‹ Ð½Ð° ÑƒÑÐ¿ÐµÑˆÐ½ÑƒÑŽ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ DAG-Ð¾Ð² Ð¸ Ð¸Ñ… ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð¾Ð¶Ð¸Ð´Ð°ÐµÐ¼Ð¾Ð¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ðµ
+ 0' ÐÐµ Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°Ð» MLFlow (ÐºÐ°Ðº-Ñ‚Ð¾ Ð¾Ñ‡ÐµÐ½ÑŒ ÑƒÐ¶ Ð¿Ð¾Ñ‚Ð½Ð¾, Ð½Ð¾ ÐµÑ‰Ñ‘ Ð½Ðµ Ð²ÐµÑ‡ÐµÑ€)
+ 0' ÐÐµ Ð²Ð·Ð¸Ð»ÑÑ Ñ Mlflow Model Registry
+ 3' ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ð» alert
+ 1  Ð¡Ð°Ð¼Ð¾Ð¾Ñ†ÐµÐ½Ð¾Ñ‡ÐºÐ°
-------------------------------------------------------------------------------------
```
**Ð˜Ð¢ÐžÐ“Ðž: 36 / 36 Ð±Ð°Ð·Ð¾Ð²Ñ‹Ñ… Ð±Ð°Ð»Ð»Ð¾Ð² + 6 / 16 Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… =** `42 / 52 Ð±Ð°Ð»Ð»Ð¾Ð²`
